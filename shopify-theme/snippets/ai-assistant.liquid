<div id="ai-assistant">
  <button class="ai-toggle closed" id="ai-toggle">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="ai-brain"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
    <span id="ai-text">{{ 'ai.button_label' | t }}</span>
    <div class="ai-toggle-badge" id="ai-badge">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      <span>{{ 'ai.experience' | t }}</span>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="ai-close" style="display:none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
  </button>

  <div class="ai-window" id="ai-window" style="display:none">
    <div class="ai-header">
      <div class="ai-header-bg"></div>
      <div class="ai-header-content">
        <div class="ai-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
        </div>
        <div style="flex:1">
          <h3 class="ai-title">{{ 'ai.title' | t }}<span class="ai-badge"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>{{ 'ai.badge' | t }}</span></h3>
          <div class="ai-status"><span style="display:flex;align-items:center;gap:0.25rem"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="#facc15"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>{{ 'ai.experience' | t }}</span><span>â€¢</span><span style="display:flex;align-items:center;gap:0.25rem"><span class="ai-status-dot"></span>{{ 'ai.status' | t }}</span></div>
        </div>
      </div>
    </div>
    <div class="ai-messages" id="ai-messages"></div>
    <div class="ai-suggestions" id="ai-suggestions">
      <div class="ai-suggestions-list">
        <button class="ai-suggestion" data-q="{{ 'ai.suggestion_1' | t }}">{{ 'ai.suggestion_1' | t }}</button>
        <button class="ai-suggestion" data-q="{{ 'ai.suggestion_2' | t }}">{{ 'ai.suggestion_2' | t }}</button>
        <button class="ai-suggestion" data-q="{{ 'ai.suggestion_3' | t }}">{{ 'ai.suggestion_3' | t }}</button>
      </div>
    </div>
    <form class="ai-input-form" id="ai-form">
      <input type="text" class="ai-input" id="ai-input" placeholder="{{ 'ai.placeholder' | t }}" autocomplete="off">
      <button type="submit" class="ai-send"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    </form>
  </div>
</div>

<script>
(function(){
  const SECRET="ÐºÐ²Ð°Ð½Ñ‚Ð¾Ð²Ð¸Ð¹ ÐºÑ–Ñ‚ ÑˆÑ€Ñ‘Ð´Ñ–Ð½Ð³ÐµÑ€Ð° 2047";
  const API='{{ settings.ai_api_url }}';
  const sid='ai-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
  let open=false,loading=false,msgs=[],secret=false;
  const t=document.getElementById('ai-toggle'),w=document.getElementById('ai-window'),
        m=document.getElementById('ai-messages'),sug=document.getElementById('ai-suggestions'),
        f=document.getElementById('ai-form'),inp=document.getElementById('ai-input'),
        brain=document.getElementById('ai-brain'),close=document.getElementById('ai-close'),
        txt=document.getElementById('ai-text'),badge=document.getElementById('ai-badge');
  const welcome=`{{ 'ai.welcome' | t }}\n\n{{ 'ai.help_intro' | t }}\n{{ 'ai.help_1' | t }}\n{{ 'ai.help_2' | t }}\n{{ 'ai.help_3' | t }}\n{{ 'ai.help_4' | t }}\n\n{{ 'ai.help_question' | t }}`;
  
  function toggle(){
    open=!open;
    if(open){w.style.display='block';t.classList.remove('closed');t.classList.add('open');brain.style.display='none';close.style.display='block';txt.style.display='none';badge.style.display='none';if(!msgs.length)add('assistant',welcome);inp.focus();}
    else{w.style.display='none';t.classList.remove('open');t.classList.add('closed');brain.style.display='block';close.style.display='none';txt.style.display='inline';badge.style.display='flex';}
  }
  function add(r,c){msgs.push({r,c});render();}
  function render(){
    m.innerHTML=msgs.map(x=>`<div class="ai-message ${x.r}"><div class="ai-message-bubble"><p class="ai-message-text">${x.c}</p></div></div>`).join('');
    if(secret)m.innerHTML+=`<div style="display:flex;justify-content:center"><button class="ai-secret-btn" onclick="window.location.href='/admin'"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>{{ 'ai.secret_button' | t }}</button></div>`;
    if(loading)m.innerHTML+=`<div class="ai-message assistant"><div class="ai-loading"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><span>{{ 'ai.thinking' | t }}</span></div></div>`;
    m.scrollTop=m.scrollHeight;
  }
  function check(t){return t.toLowerCase().trim().replace(/\s+/g,' ')===SECRET.toLowerCase().trim().replace(/\s+/g,' ');}
  async function send(txt){
    if(!txt.trim()||loading)return;
    if(check(txt)){add('user','â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢');inp.value='';setTimeout(()=>{add('assistant',`{{ 'ai.secret_success' | t }}\n\n{{ 'ai.secret_welcome' | t }}`);secret=true;sug.style.display='none';render();},500);return;}
    add('user',txt);inp.value='';loading=true;render();
    try{
      if(API){const r=await fetch(API+'/api/ai/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sid,message:txt})});if(!r.ok)throw new Error();const d=await r.json();add('assistant',d.response);}
      else add('assistant','Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ! AI-ÑÐµÑ€Ð²Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. Ð¡Ð²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ‡ÐµÑ€ÐµÐ· Telegram: @duso_ecom ðŸ“±');
    }catch(e){add('assistant','ÐžÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ Ð¸Ð»Ð¸ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Telegram: @duso_ecom ðŸ“±');}
    finally{loading=false;render();}
  }
  t.addEventListener('click',toggle);
  f.addEventListener('submit',e=>{e.preventDefault();send(inp.value);});
  document.querySelectorAll('.ai-suggestion').forEach(b=>b.addEventListener('click',()=>send(b.dataset.q)));
})();
</script>
