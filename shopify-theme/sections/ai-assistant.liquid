{% comment %}
  AI Assistant Section - Exact copy from React AIAssistant.jsx
{% endcomment %}

<!-- AI Chat Button -->
<button
  id="ai-chat-button"
  data-testid="ai-chat-button"
  onclick="toggleAIChat()"
  class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full shadow-lg shadow-orange-500/30 flex items-center justify-center text-white hover:scale-110 transition-all duration-300 z-50 group"
>
  <i data-lucide="message-circle" class="w-6 h-6 group-hover:scale-110 transition-transform" id="chat-icon"></i>
  <i data-lucide="x" class="w-6 h-6 hidden" id="close-icon"></i>
  
  <!-- Pulse animation -->
  <span class="absolute inset-0 rounded-full bg-orange-500 animate-ping opacity-30"></span>
</button>

<!-- AI Chat Panel -->
<div
  id="ai-chat-panel"
  class="fixed bottom-24 right-6 w-[380px] h-[500px] glass rounded-2xl border border-orange-500/30 shadow-2xl shadow-orange-500/10 flex-col overflow-hidden z-50 hidden"
>
  <!-- Header -->
  <div class="p-4 border-b border-white/10 bg-gradient-to-r from-orange-500/10 to-transparent">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
      </div>
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <h3 class="text-white font-semibold">{{ 'ai_assistant.title' | t }}</h3>
          <span class="text-[10px] px-2 py-0.5 bg-emerald-500/20 text-emerald-500 rounded-full">{{ 'ai_assistant.badge' | t }}</span>
        </div>
        <p class="text-gray-500 text-xs">{{ 'ai_assistant.experience' | t }}</p>
      </div>
      <div class="flex items-center gap-1">
        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
        <span class="text-emerald-500 text-xs">{{ 'ai_assistant.online' | t }}</span>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div id="ai-messages" class="flex-1 overflow-y-auto p-4 space-y-4" style="max-height: 320px;">
    <!-- Welcome Message -->
    <div class="flex gap-3" id="welcome-message">
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center flex-shrink-0">
        <i data-lucide="bot" class="w-4 h-4 text-white"></i>
      </div>
      <div class="glass rounded-2xl rounded-tl-sm p-4 max-w-[280px]">
        <p class="text-white text-sm mb-3">{{ 'ai_assistant.welcome' | t }}</p>
        <p class="text-gray-400 text-sm mb-2">Я могу помочь:</p>
        <ul class="text-gray-400 text-sm space-y-1">
          <li class="flex items-start gap-2">
            <i data-lucide="check" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>
            <span>{{ 'ai_assistant.help_1' | t }}</span>
          </li>
          <li class="flex items-start gap-2">
            <i data-lucide="check" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>
            <span>{{ 'ai_assistant.help_2' | t }}</span>
          </li>
          <li class="flex items-start gap-2">
            <i data-lucide="check" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>
            <span>{{ 'ai_assistant.help_3' | t }}</span>
          </li>
          <li class="flex items-start gap-2">
            <i data-lucide="check" class="w-4 h-4 text-emerald-500 flex-shrink-0 mt-0.5"></i>
            <span>{{ 'ai_assistant.help_4' | t }}</span>
          </li>
        </ul>
        <p class="text-orange-500 text-sm mt-3 font-medium">{{ 'ai_assistant.ask' | t }}</p>
      </div>
    </div>
  </div>

  <!-- Suggestions -->
  <div id="ai-suggestions" class="px-4 pb-2">
    <div class="flex flex-wrap gap-2">
      <button onclick="sendSuggestion('{{ 'ai_assistant.suggestion_1' | t }}')" class="text-xs px-3 py-1.5 glass rounded-full text-gray-400 hover:text-white hover:border-orange-500/30 transition-all">
        {{ 'ai_assistant.suggestion_1' | t }}
      </button>
      <button onclick="sendSuggestion('{{ 'ai_assistant.suggestion_2' | t }}')" class="text-xs px-3 py-1.5 glass rounded-full text-gray-400 hover:text-white hover:border-orange-500/30 transition-all">
        {{ 'ai_assistant.suggestion_2' | t }}
      </button>
      <button onclick="sendSuggestion('{{ 'ai_assistant.suggestion_3' | t }}')" class="text-xs px-3 py-1.5 glass rounded-full text-gray-400 hover:text-white hover:border-orange-500/30 transition-all">
        {{ 'ai_assistant.suggestion_3' | t }}
      </button>
    </div>
  </div>

  <!-- Input -->
  <div class="p-4 border-t border-white/10">
    <div class="flex gap-2">
      <input
        type="text"
        id="ai-input"
        data-testid="ai-input"
        placeholder="{{ 'ai_assistant.placeholder' | t }}"
        class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white text-sm placeholder-gray-500 focus:outline-none focus:border-orange-500/50 transition-colors"
        onkeypress="if(event.key === 'Enter') sendMessage()"
      >
      <button
        id="ai-send-button"
        data-testid="ai-send-button"
        onclick="sendMessage()"
        class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl flex items-center justify-center text-white hover:from-orange-600 hover:to-orange-700 transition-all duration-300"
      >
        <i data-lucide="send" class="w-5 h-5"></i>
      </button>
    </div>
  </div>
</div>

<!-- Secret Admin Panel -->
<div
  id="admin-panel"
  class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden"
>
  <div class="glass rounded-2xl p-8 max-w-md w-full mx-4 border border-emerald-500/30">
    <div class="text-center">
      <div class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
        <i data-lucide="shield-check" class="w-8 h-8 text-emerald-500"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">{{ 'ai_assistant.secret_success' | t }}</h3>
      <p class="text-gray-400 mb-6">{{ 'ai_assistant.secret_welcome' | t }}</p>
      <a
        href="/admin/login"
        id="admin-panel-link"
        class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-6 py-3 rounded-xl inline-flex items-center gap-2 hover:from-emerald-600 hover:to-emerald-700 transition-all"
      >
        {{ 'ai_assistant.secret_button' | t }}
        <i data-lucide="arrow-right" class="w-5 h-5"></i>
      </a>
      <button onclick="closeAdminPanel()" class="block mx-auto mt-4 text-gray-500 hover:text-white transition-colors">
        Закрити
      </button>
    </div>
  </div>
</div>

<script>
const SECRET_CODE = 'квантовий кіт шрёдінгера 2047';
const API_URL = '{{ shop.secure_url }}/apps/duso-ai';
let conversationHistory = [];
let isOpen = false;

function toggleAIChat() {
  isOpen = !isOpen;
  const panel = document.getElementById('ai-chat-panel');
  const chatIcon = document.getElementById('chat-icon');
  const closeIcon = document.getElementById('close-icon');
  
  if (isOpen) {
    panel.classList.remove('hidden');
    panel.classList.add('flex');
    chatIcon.classList.add('hidden');
    closeIcon.classList.remove('hidden');
  } else {
    panel.classList.add('hidden');
    panel.classList.remove('flex');
    chatIcon.classList.remove('hidden');
    closeIcon.classList.add('hidden');
  }
  
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

function sendSuggestion(text) {
  document.getElementById('ai-input').value = text;
  sendMessage();
}

function addMessage(content, isUser = false) {
  const messagesContainer = document.getElementById('ai-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = isUser ? 'flex gap-3 justify-end' : 'flex gap-3';
  
  if (isUser) {
    messageDiv.innerHTML = `
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-2xl rounded-tr-sm p-4 max-w-[280px]">
        <p class="text-white text-sm">${content}</p>
      </div>
      <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center flex-shrink-0">
        <i data-lucide="user" class="w-4 h-4 text-white"></i>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center flex-shrink-0">
        <i data-lucide="bot" class="w-4 h-4 text-white"></i>
      </div>
      <div class="glass rounded-2xl rounded-tl-sm p-4 max-w-[280px]">
        <p class="text-white text-sm">${content}</p>
      </div>
    `;
  }
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

function showTypingIndicator() {
  const messagesContainer = document.getElementById('ai-messages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  typingDiv.className = 'flex gap-3';
  typingDiv.innerHTML = `
    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center flex-shrink-0">
      <i data-lucide="bot" class="w-4 h-4 text-white"></i>
    </div>
    <div class="glass rounded-2xl rounded-tl-sm p-4">
      <div class="flex gap-1">
        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
      </div>
    </div>
  `;
  messagesContainer.appendChild(typingDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
}

function hideTypingIndicator() {
  const typing = document.getElementById('typing-indicator');
  if (typing) typing.remove();
}

function showAdminPanel() {
  document.getElementById('admin-panel').classList.remove('hidden');
}

function closeAdminPanel() {
  document.getElementById('admin-panel').classList.add('hidden');
}

async function sendMessage() {
  const input = document.getElementById('ai-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Check for secret code
  if (message.toLowerCase() === SECRET_CODE.toLowerCase()) {
    addMessage(message, true);
    input.value = '';
    showAdminPanel();
    return;
  }
  
  // Hide suggestions after first message
  document.getElementById('ai-suggestions').classList.add('hidden');
  
  addMessage(message, true);
  input.value = '';
  
  conversationHistory.push({ role: 'user', content: message });
  
  showTypingIndicator();
  
  try {
    // Try to call the backend API
    const response = await fetch('/apps/duso-ai/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        history: conversationHistory
      })
    });
    
    hideTypingIndicator();
    
    if (response.ok) {
      const data = await response.json();
      const aiResponse = data.response || data.message;
      addMessage(aiResponse);
      conversationHistory.push({ role: 'assistant', content: aiResponse });
    } else {
      // Fallback response
      const fallbackResponse = getFallbackResponse(message);
      addMessage(fallbackResponse);
      conversationHistory.push({ role: 'assistant', content: fallbackResponse });
    }
  } catch (error) {
    hideTypingIndicator();
    // Fallback response if API fails
    const fallbackResponse = getFallbackResponse(message);
    addMessage(fallbackResponse);
    conversationHistory.push({ role: 'assistant', content: fallbackResponse });
  }
}

function getFallbackResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('стоимость') || lowerMessage.includes('цена') || lowerMessage.includes('сколько')) {
    return 'Стоимость разработки Shopify магазина начинается от $2,500. Точная цена зависит от сложности проекта, количества товаров и необходимых интеграций. Хотите получить индивидуальный расчёт? Напишите нам в Telegram: @duso_ecom';
  }
  
  if (lowerMessage.includes('гарант') || lowerMessage.includes('возврат')) {
    return 'Мы даём гарантию на все наши работы: ✓ Бесплатные правки в течение 30 дней после запуска ✓ Техподдержка 24/7 ✓ Возврат 100% при невыполнении условий договора. Работаем по договору с чётким ТЗ.';
  }
  
  if (lowerMessage.includes('кейс') || lowerMessage.includes('портфолио') || lowerMessage.includes('пример')) {
    return 'У нас более 6500+ успешных проектов! Средний рост продаж наших клиентов +180%. Посмотрите раздел "Портфолио" на сайте или напишите нам — пришлём релевантные кейсы из вашей ниши.';
  }
  
  if (lowerMessage.includes('срок') || lowerMessage.includes('время') || lowerMessage.includes('долго')) {
    return 'Сроки разработки: • Базовый магазин: 2-3 недели • Средний проект: 3-4 недели • Сложный/кастомный: 4-6 недель. Мы всегда укладываемся в оговоренные сроки!';
  }
  
  return 'Спасибо за ваш вопрос! Для детальной консультации свяжитесь с нами: Telegram: @duso_ecom или оставьте заявку на сайте. Наши эксперты ответят в течение 15 минут!';
}
</script>

{% schema %}
{
  "name": "AI Assistant",
  "settings": []
}
{% endschema %}
